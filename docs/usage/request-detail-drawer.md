# è¯·æ±‚è¯¦æƒ…æŠ½å±‰ä½¿ç”¨æ‰‹å†Œï¼ˆUsage â†’ Request Detailï¼‰

æœ¬æ‰‹å†Œä¸“é—¨è¯´æ˜â€œä½¿ç”¨è®°å½• / è¯·æ±‚è¯¦æƒ…æŠ½å±‰â€çš„å­—æ®µå«ä¹‰ä¸æ’éšœæ–¹æ³•ï¼Œè¦†ç›–æ¯ä¸ª Tab çš„æ•°æ®æ¥æºä¸å¸¸è§é—®é¢˜å®šä½ã€‚

æˆªå›¾å‚è€ƒï¼š`docs/screenshots/usage.png`ã€`docs/screenshots/tracing.png`

## 1. å…¥å£ä¸æƒé™

å…¥å£ï¼š

1. ç®¡ç†åå° â†’ **ä½¿ç”¨è®°å½•**ï¼ˆ`/admin/usage`ï¼‰
2. ç‚¹å‡»æŸæ¡è¯·æ±‚è®°å½• â†’ æ‰“å¼€ **è¯·æ±‚è¯¦æƒ…æŠ½å±‰**

è¯´æ˜ï¼š

- æ™®é€šç”¨æˆ·ä¹Ÿèƒ½çœ‹åˆ°ä½¿ç”¨è®°å½•ï¼Œä½†â€œè¯·æ±‚è¯¦æƒ…æŠ½å±‰/é“¾è·¯è¿½è¸ª/å‡ºç«™ headersâ€ç­‰å­—æ®µé€šå¸¸åªå¯¹ç®¡ç†å‘˜å¯è§ï¼ˆä»¥å®é™… UI ä¸ºå‡†ï¼‰ã€‚
- æŠ½å±‰æ•°æ®æ¥è‡ª `GET /api/admin/usage/{usage_id}`ï¼ˆç®¡ç†å‘˜æ¥å£ï¼‰ã€‚

ğŸ“ å‚è€ƒï¼š`src/api/admin/usage/routes.py:230`

## 2. é¡¶éƒ¨æ‘˜è¦åŒºï¼šå…ˆçœ‹è¿™å‡ é¡¹

æŠ½å±‰å¤´éƒ¨é€šå¸¸åŒ…å«ï¼š

1. **æ¨¡å‹å**ï¼š`model`ï¼ˆè¯·æ±‚é‡Œå†™çš„æ¨¡å‹ï¼‰â†’ `target_model`ï¼ˆè·¯ç”±åå®é™…å‘½ä¸­çš„ç›®æ ‡æ¨¡å‹/åˆ«åæ˜ å°„ç»“æœï¼‰
2. **çŠ¶æ€ç **ï¼š`status_code`ï¼ˆ200 å¸¸è§ä¸ºæˆåŠŸï¼Œå…¶ä½™ç»“åˆ `error_message` åˆ¤æ–­ï¼‰
3. **è¯·æ±‚ç±»å‹**ï¼š`is_stream`ï¼ˆæµå¼/æ ‡å‡†ï¼‰
4. **è¯·æ±‚ ID**ï¼š`request_id` æˆ– `id`ï¼ˆç”¨äºé“¾è·¯è¿½è¸ªä¸æ’æŸ¥å®šä½ï¼‰
5. **API æ ¼å¼**ï¼š`api_format`ï¼ˆOpenAI/Claude/Gemini/CLI ç­‰ï¼‰
6. **è€—æ—¶**ï¼š`response_time_ms`ã€`first_byte_time_ms`ï¼ˆTTFBï¼‰

ğŸ“ å‚è€ƒï¼š`src/api/admin/usage/routes.py:887`

## 3. è´¹ç”¨ä¸ç”¨é‡åŒºï¼šå¦‚ä½•ç†è§£æˆæœ¬å±•ç¤º

å¸¸è§å­—æ®µï¼š

- tokensï¼š
  - `input / output / total`
  - `cache_creation_input_tokens`ã€`cache_read_input_tokens`ï¼ˆå¦‚æœæœ‰ç¼“å­˜èƒ½åŠ›ï¼‰
- costï¼š
  - `input_cost_usd / output_cost_usd / total_cost_usd`
  - `cache_creation_cost`ã€`cache_read_cost`
  - `request_cost`ï¼ˆæŒ‰æ¬¡è®¡è´¹ï¼‰
- ä»·æ ¼ï¼š
  - `input_price_per_1m / output_price_per_1m`
  - `cache_creation_price_per_1m / cache_read_price_per_1m`
  - `price_per_request`
- é˜¶æ¢¯è®¡è´¹ï¼š
  - `tiered_pricing`ï¼ˆä¼šæ˜¾ç¤ºé˜¶æ¢¯æ¥æº `source=provider/global`ã€å‘½ä¸­é˜¶æ¢¯ã€ä¸Šä¸‹æ–‡æ€»è¾“å…¥ç­‰ï¼‰

ç”¨é€”ï¼š

1. æ ¡éªŒâ€œä¸ºä»€ä¹ˆè¿™æ¬¡æˆæœ¬å¼‚å¸¸é«˜/ä½â€ï¼ˆé˜¶æ¢¯å‘½ä¸­ã€ç¼“å­˜è¯»å†™æ¯”ä¾‹ã€æŒ‰æ¬¡è®¡è´¹æ˜¯å¦å åŠ ï¼‰ã€‚
2. ç»“åˆ Provider/GlobalModel çš„å®šä»·é…ç½®å®šä½â€œå®šä»·æ¥æºæ˜¯å¦ç¬¦åˆé¢„æœŸâ€ã€‚

ğŸ“ å‚è€ƒï¼š`src/api/admin/usage/routes.py:926`

## 4. è¯·æ±‚é“¾è·¯è¿½è¸ªï¼ˆTraceï¼‰ï¼šçœ‹é‡è¯•ä¸å€™é€‰è·¯å¾„

åœ¨è¯·æ±‚è¯¦æƒ…æŠ½å±‰ä¸­ä¼šå±•ç¤ºâ€œè¯·æ±‚é“¾è·¯è¿½è¸ªâ€å¡ç‰‡ï¼ˆæŒ‰ Provider åˆ†ç»„çš„æ—¶é—´çº¿ï¼‰ã€‚

ä½ å¯ä»¥ç”¨å®ƒå›ç­”ï¼š

1. è¿™æ¬¡è¯·æ±‚åˆ°åº•èµ°äº†å“ªä¸ª Provider/Key/Endpointï¼Ÿ
2. å‘ç”Ÿäº†å‡ æ¬¡å°è¯•ï¼ˆé‡è¯•/æ¢ Key/æ•…éšœè½¬ç§»ï¼‰ï¼Ÿæ¯æ¬¡å¤±è´¥åŸå› æ˜¯ä»€ä¹ˆï¼Ÿ
3. æ˜¯å¦å‡ºç° `skipped`ï¼Ÿè·³è¿‡ç†ç”±ï¼ˆä¾‹å¦‚ç™½åå•ä¸å…è®¸ã€èƒ½åŠ›ä¸æ»¡è¶³ã€ç†”æ–­ç­‰ï¼‰æ˜¯ä»€ä¹ˆï¼Ÿ

å­—æ®µé€ŸæŸ¥ï¼š

- `status`ï¼š`pending/streaming/success/failed/skipped`
- `status_code`ï¼šä¸Šæ¸¸ HTTP çŠ¶æ€ç ï¼ˆå¦‚æœæœ‰ï¼‰
- `error_type / error_message`ï¼šé”™è¯¯åˆ†ç±»ä¸ä¿¡æ¯
- `latency_ms`ï¼šå•æ¬¡å€™é€‰å»¶è¿Ÿ
- `key_preview`ï¼šè„±æ• Keyï¼ˆç”¨äºå®šä½åˆ°åº•æ˜¯å“ªæŠŠ Provider Keyï¼‰
- `required_capabilities` vs `key_capabilities`ï¼šèƒ½åŠ›è¦æ±‚ä¸ Key å£°æ˜ï¼ˆè§£é‡Šâ€œä¸ºä»€ä¹ˆè¢«è·³è¿‡â€ï¼‰

API å…¥å£ï¼š`GET /api/admin/monitoring/trace/{request_id}`

ğŸ“ å‚è€ƒï¼š`src/api/admin/monitoring/trace.py:55`

## 5. Tabsï¼ˆæœ€å¸¸ç”¨ï¼‰ï¼šæ¯ä¸ª Tab çœ‹ä»€ä¹ˆ

æŠ½å±‰ä¸‹æ–¹é€šå¸¸åŒ…å«å¤šä¸ª Tabï¼›ç³»ç»Ÿä¼šâ€œæŒ‰æ˜¯å¦æœ‰æ•°æ®â€è‡ªåŠ¨éšè—ç©º Tabã€‚

### 5.1 Request Headersï¼ˆè¯·æ±‚å¤´ï¼‰

å­—æ®µæ¥æºï¼š

- `request_headers`ï¼šå®¢æˆ·ç«¯ â†’ Aether å…¥ç«™è¯·æ±‚å¤´
- `provider_request_headers`ï¼šAether â†’ Provider å‡ºç«™è¯·æ±‚å¤´ï¼ˆæœ€ç»ˆå½¢æ€ï¼‰

é¡µé¢æä¾›ä¸‰ç§è§†å›¾ï¼š

1. **å¯¹æ¯”ï¼ˆé»˜è®¤ï¼‰**ï¼šadded/modified/removed/unchangedï¼ˆå¯¹æ¯”å…¥ç«™ vs å‡ºç«™ï¼‰
2. **å®¢æˆ·ç«¯**ï¼šåªçœ‹ `request_headers`
3. **æä¾›å•†**ï¼šåªçœ‹ `provider_request_headers`

å¸¸ç”¨æ’éšœï¼š

1. â€œè‡ªå®šä¹‰ headers ä¸ç”Ÿæ•ˆâ€ï¼šå…ˆåœ¨å¯¹æ¯”è§†å›¾é‡Œç¡®è®¤è¯¥ header æ˜¯å¦å‡ºç°åœ¨ `provider_request_headers` ä¸­ï¼›è‹¥ç¼ºå¤±ï¼Œæ£€æŸ¥ Endpoint çš„ headers è§„åˆ™ä¸æœ€é«˜å®‰å…¨è§„åˆ™ã€‚
2. â€œé‰´æƒå¤´è¢«è¦†ç›–â€ï¼šç¡®è®¤ `Authorization/x-api-key/x-goog-api-key` æ˜¯å¦è¢«ç³»ç»Ÿä¿æŠ¤ï¼ˆè‡ªå®šä¹‰è§„åˆ™ä¸èƒ½è¦†ç›–ï¼‰ã€‚

æ›´å®Œæ•´çš„â€œå®¢æˆ·ç«¯è¯·æ±‚å¤´ vs æä¾›å•†è¯·æ±‚å¤´â€æ¥æºé“¾è·¯è¯´æ˜è§ï¼š`docs/usage/request-detail-headers.md`

ğŸ“ å‚è€ƒï¼š`frontend/src/features/usage/components/RequestDetailDrawer.vue:407`

### 5.2 Request Bodyï¼ˆè¯·æ±‚ä½“ï¼‰

å­—æ®µæ¥æºï¼š`request_body`

å¸¸è§ç”¨é€”ï¼š

1. ç¡®è®¤ `model/messages/stream` ç­‰å…³é”®å‚æ•°æ˜¯å¦æ­£ç¡®ï¼ˆå°¤å…¶æ˜¯ SDK äºŒæ¬¡å°è£…æ—¶ï¼‰ã€‚
2. æ’æŸ¥â€œå‚æ•°ä¸å®é™… SDK å‘é€çš„ä¸ä¸€è‡´â€ã€‚

å¦‚æœä¸ºç©ºï¼š

- å¯èƒ½æ˜¯ç³»ç»Ÿæ—¥å¿—çº§åˆ«ä¸è®°å½• body æˆ–å·²è¢«æ¸…ç†/å‹ç¼©ï¼ˆè§ç³»ç»Ÿè®¾ç½®çš„æ—¥å¿—ç­–ç•¥ï¼‰ã€‚

ğŸ“ å‚è€ƒï¼š`src/api/admin/usage/routes.py:917`

### 5.3 Response Headersï¼ˆå“åº”å¤´ï¼‰

å­—æ®µæ¥æºï¼ˆå‰ç«¯é€»è¾‘ï¼‰ï¼š

- ä¼˜å…ˆå±•ç¤º `client_response_headers`ï¼ˆè¿”å›ç»™å®¢æˆ·ç«¯çš„å“åº”å¤´ï¼‰
- å¦‚æœä¸ºç©ºï¼Œå›é€€å±•ç¤º `response_headers`ï¼ˆProvider å“åº”å¤´ï¼‰

ç”¨é€”ï¼š

1. çœ‹ Aether æ˜¯å¦å¯¹å“åº”å¤´åšäº†å˜æ¢/è¿‡æ»¤ï¼ˆä¾‹å¦‚æµå¼å“åº”ã€ç¼“å­˜ç›¸å…³å¤´ï¼‰ã€‚
2. è¾…åŠ©å®šä½é™é€Ÿ/é‡è¯•ï¼ˆéƒ¨åˆ†ä¸Šæ¸¸ä¼šåœ¨å“åº”å¤´å†™å…¥é€Ÿç‡ä¿¡æ¯ï¼‰ã€‚

ğŸ“ å‚è€ƒï¼š`frontend/src/features/usage/components/RequestDetailDrawer.vue:626`

### 5.4 Response Bodyï¼ˆå“åº”ä½“ï¼‰

å­—æ®µæ¥æºï¼š`response_body`

ç”¨é€”ï¼š

1. å¿«é€Ÿç¡®è®¤è¿”å›å†…å®¹ï¼ˆå°¤å…¶æ˜¯å¤±è´¥æ—¶çš„é”™è¯¯ç»“æ„/é”™è¯¯ç ï¼‰ã€‚
2. æ’æŸ¥â€œä¸Šæ¸¸è¿”å›äº†é”™è¯¯ä½†è¢«åŒ…è£…/è½¬æ¢åå¯¼è‡´å®¢æˆ·ç«¯éš¾ä»¥ç†è§£â€çš„æƒ…å†µã€‚

æ³¨æ„ï¼š

- æµå¼è¯·æ±‚çš„å“åº”ä½“å¯èƒ½è¢«æˆªæ–­æˆ–ä¸å®Œæ•´ï¼ˆå–å†³äºç³»ç»Ÿè®°å½•ç­–ç•¥ä¸ä½“ç§¯é™åˆ¶ï¼‰ã€‚

ğŸ“ å‚è€ƒï¼š`src/api/admin/usage/routes.py:921`

### 5.5 Metadataï¼ˆå…ƒæ•°æ®ï¼‰

å­—æ®µæ¥æºï¼š`metadata`ï¼ˆåç«¯å­—æ®µåä¸º `request_metadata`ï¼‰

ç”¨é€”ï¼š

1. å­˜æ”¾ä¸ Provider å“åº”/è·¯ç”±ç›¸å…³çš„è¡¥å……ä¿¡æ¯ï¼ˆä¾‹å¦‚æŸäº› timingã€å†…éƒ¨æ ‡è®°ã€å€™é€‰ä¿¡æ¯æ‘˜è¦ç­‰ï¼Œå–å†³äºç‰ˆæœ¬ï¼‰ã€‚
2. å½“ä½ éœ€è¦æ›´ç»†é¢—ç²’åº¦çš„è°ƒè¯•ä¿¡æ¯ä½†ä¸é€‚åˆæ”¾åœ¨ body/headers æ—¶ï¼Œé€šå¸¸ä¼šå‡ºç°åœ¨è¿™é‡Œã€‚

ğŸ“ å‚è€ƒï¼š`src/api/admin/usage/routes.py:922`

## 6. â€œä¸ºç©º/ä¸å…¨/è¢«***â€çš„åŸå› ï¼ˆä¸æ˜¯ bug çš„é‚£ç±»ï¼‰

è¯·æ±‚è¯¦æƒ…é‡Œ headers/body/metadata ä¸ºç©ºæˆ–è¢«è„±æ•ï¼Œé€šå¸¸ç”±ç³»ç»Ÿè®¾ç½®å†³å®šï¼š

1. **è®°å½•çº§åˆ«**ï¼š`basic/headers/full`ï¼ˆè¶Šé«˜è¶Šå®Œæ•´ï¼Œä½†æ›´æ•æ„Ÿã€æ›´å ç©ºé—´ï¼‰
2. **å¤§å°é™åˆ¶**ï¼šæœ€å¤§è¯·æ±‚/å“åº”ä½“å¤§å°ï¼ˆKBï¼‰è¶…å‡ºä¼šæˆªæ–­è®°å½•
3. **è„±æ•è§„åˆ™**ï¼šæ•æ„Ÿ header ä¼šè¢« `***` æ›¿æ¢
4. **æ¸…ç†ç­–ç•¥**ï¼šæ—¥å¿—ä¼šåˆ†çº§ä¿ç•™å¹¶æŒ‰ç­–ç•¥æ¸…ç†/å‹ç¼©ï¼ˆæ—¶é—´ä¹…äº†å¯èƒ½åªå‰©ç»Ÿè®¡å­—æ®µï¼‰

å…¥å£ï¼šç®¡ç†åå° â†’ ç³»ç»Ÿè®¾ç½®

ğŸ“ å‚è€ƒï¼š`frontend/src/views/admin/SystemSettings.vue:218`

