# 安全与合规（IP / 邮件 / LDAP / 审计 / 脱敏）

本文覆盖管理后台的安全相关功能：IP 安全、邮件配置与邮箱注册限制、LDAP、审计日志、请求日志记录级别与脱敏，以及 Endpoint 自定义 Headers 的最高安全规则。

## 1. IP 安全（白名单 / 黑名单）

路径：**管理后台 → IP 安全**

### 1.1 IP 黑名单（阻断访问）

用途：阻止特定 IP 访问系统接口（常用于封禁异常流量）。

操作：

1. 点击“IP 黑名单”卡片右上角“+”。
2. 填写：
   - `IP 地址`：例如 `203.0.113.10`
   - `原因`：可选，便于审计
   - `过期时间（秒）`：留空为永久；例如 `3600` 表示 1 小时后自动解封
3. 确认保存。

提示：

- 如果页面提示 Redis 不可用，说明黑名单功能依赖 Redis（需先恢复 Redis）。

### 1.2 IP 白名单（可信 IP）

用途：维护可信任来源（常用于限制管理后台访问、或给自动化脚本固定出口放行）。

操作：

1. 点击“IP 白名单”卡片右上角“+”。
2. 输入 IP 或 CIDR（页面提示支持 CIDR）：
   - 单 IP：`192.0.2.10`
   - 段：`192.0.2.0/24`
3. 保存后，白名单会在列表中展示，可随时移除。

📎 参考：`frontend/src/views/admin/IPSecurity.vue:1`

## 2. 邮件配置（SMTP + 模板）与邮箱注册限制

路径：**管理后台 → 邮箱设置**

### 2.1 SMTP 配置（用于验证码/通知邮件）

操作：

1. 填写 SMTP 服务器参数：
   - `SMTP 服务器地址`（如 `smtp.gmail.com`）
   - `SMTP 端口`（常见：587 TLS / 465 SSL）
   - `SMTP 用户名`、`SMTP 密码/应用专用密码`
   - `发件人邮箱`、`发件人名称`
   - `加密方式`（SSL/TLS/无）
2. 点击“测试连接”确认可用。
3. 点击“保存”生效。

注意：

- 密码字段通常支持“已设置（留空保持不变）”的编辑体验；要清空可用“清除密码”按钮。

### 2.2 邮件模板（HTML）

用途：自定义不同类型邮件的 HTML 模板，并支持变量插值。

操作：

1. 在“邮件模板”区域选择模板类型。
2. 编辑 HTML 内容。
3. 参考页面提示的“可用变量”（以 UI 展示为准）。
4. 点击“保存”。

📎 参考：`frontend/src/views/admin/EmailSettings.vue:1`

## 3. LDAP（企业账号体系接入）

路径：**管理后台 → LDAP 设置**

### 3.1 基础连接参数

1. 填写 `服务器地址`：
   - `ldap://host:389` 或 `ldaps://host:636`
2. 填写绑定账号（用于查询用户）：
   - `绑定 DN`（如 `cn=admin,dc=example,dc=com`）
   - `绑定密码`
3. 配置用户搜索：
   - `基础 DN`（如 `ou=users,dc=example,dc=com`）
   - `用户搜索过滤器`（如 `(uid={username})`，`{username}` 会被替换）
4. 配置属性映射：
   - `用户名属性`（OpenLDAP 常见 `uid`；AD 常见 `sAMAccountName`）
   - `邮箱属性`（常见 `mail`）
   - `显示名称属性`（常见 `cn`）
5. 设置 `连接超时（秒）`（跨国网络建议 15–30 秒）。

### 3.2 连接加密与启用策略

1. `使用 STARTTLS`：在非 SSL 连接上启用 TLS。
2. `启用 LDAP 认证`：允许用户用 LDAP 登录。
3. `仅允许 LDAP 登录`：禁用本地账号登录（启用前务必确认 LDAP 可用，避免锁死）。

### 3.3 验证与上线建议

1. 先点击“测试连接”。
2. 再保存配置并启用。
3. 建议先用一个测试账号验证登录流程，再切换到“仅允许 LDAP 登录”。

📎 参考：`frontend/src/views/admin/LdapSettings.vue:1`

## 4. 审计日志（Audit Logs）

路径：**管理后台 → 审计日志**

用途：追踪用户登录、管理操作、请求成功/失败等事件，用于合规与排障。

常用操作：

1. 搜索：按用户 ID 或关键字（以 UI 提示为准）。
2. 过滤：按事件类型、时间范围过滤。
3. 导出：点击“下载”导出当前筛选结果。
4. 查看详情：点击某条日志行打开详情（包含描述、IP、状态码、元数据等）。

📎 参考：`frontend/src/views/admin/AuditLogs.vue:1`

## 5. 请求日志记录级别、脱敏与自动清理

路径：**管理后台 → 系统设置**

### 5.1 记录级别（request_log_level）

- `basic`：仅基础字段（占用最小）
- `headers`：记录 headers（会对敏感 header 脱敏）
- `full`：记录更完整的请求/响应 body（更敏感、更占空间，慎用）

### 5.2 截断与脱敏

1. `最大请求体大小/最大响应体大小（KB）`：超过大小的 body 会被截断记录。
2. `敏感请求头`：逗号分隔（例如 `authorization, x-api-key, cookie`），这些 header 会被脱敏。

### 5.3 日志清理策略（分级保留）

你可以配置：

1. 是否启用自动清理（通常为每天定时执行）。
2. 详细日志/压缩日志/请求头/完整记录/审计日志的保留天数。
3. 单批次清理记录数（避免对数据库造成峰值压力）。

📎 参考：`frontend/src/views/admin/SystemSettings.vue:218`

## 6. Endpoint 自定义 Headers 的最高安全规则

自定义 Headers/规则属于“配置输入”，必须遵守最高安全规则：

1. 不能注入/覆盖系统敏感或协议相关 headers（例如 `Authorization`、`x-api-key`、`x-goog-api-key`、`Host`、`Content-Length` 等）。
2. 上游认证 header 由系统根据 Provider Key 自动注入并强制保护。

如果你发现某个 header 无法生效，优先按如下顺序排查：

1. 是否命中上述“受保护 headers”规则（会被拦截/覆盖）。
2. 该 header 是否应该写在“Endpoint 出站 headers”（而不是客户端入站 headers）。
3. 用“模型检测（Test Model）”验证出站 headers 是否符合预期。

📎 参考：`src/api/handlers/base/endpoint_checker.py:74`
